{"version":3,"file":"annotatescrollbar.js","sources":["../../../../src/addon/scroll/annotatescrollbar.js"],"sourcesContent":["// Source: https://github.com/codemirror/CodeMirror/tree/master/addon/scroll/annotatescrollbar.js\nexport default function(CodeMirror) {\n  \"use strict\";\n\n  CodeMirror.defineExtension(\"annotateScrollbar\", function(options) {\n    if (typeof options == \"string\") options = {className: options};\n    return new Annotation(this, options);\n  });\n\n  CodeMirror.defineOption(\"scrollButtonHeight\", 0);\n\n  function Annotation(cm, options) {\n    this.cm = cm;\n    this.options = options;\n    this.buttonHeight = options.scrollButtonHeight || cm.getOption(\"scrollButtonHeight\");\n    this.annotations = [];\n    this.doRedraw = this.doUpdate = null;\n    this.div = cm.getWrapperElement().appendChild(document.createElement(\"div\"));\n    this.div.style.cssText = \"position: absolute; right: 0; top: 0; z-index: 7; pointer-events: none\";\n    this.computeScale();\n\n    function scheduleRedraw(delay) {\n      clearTimeout(self.doRedraw);\n      self.doRedraw = setTimeout(function() { self.redraw(); }, delay);\n    }\n\n    var self = this;\n    cm.on(\"refresh\", this.resizeHandler = function() {\n      clearTimeout(self.doUpdate);\n      self.doUpdate = setTimeout(function() {\n        if (self.computeScale()) scheduleRedraw(20);\n      }, 100);\n    });\n    cm.on(\"markerAdded\", this.resizeHandler);\n    cm.on(\"markerCleared\", this.resizeHandler);\n    if (options.listenForChanges !== false)\n      cm.on(\"changes\", this.changeHandler = function() {\n        scheduleRedraw(250);\n      });\n  }\n\n  Annotation.prototype.computeScale = function() {\n    var cm = this.cm;\n    var hScale = (cm.getWrapperElement().clientHeight - cm.display.barHeight - this.buttonHeight * 2) /\n      cm.getScrollerElement().scrollHeight\n    if (hScale != this.hScale) {\n      this.hScale = hScale;\n      return true;\n    }\n  };\n\n  Annotation.prototype.update = function(annotations) {\n    this.annotations = annotations;\n    this.redraw();\n  };\n\n  Annotation.prototype.redraw = function(compute) {\n    if (compute !== false) this.computeScale();\n    var cm = this.cm, hScale = this.hScale;\n\n    var frag = document.createDocumentFragment(), anns = this.annotations;\n\n    var wrapping = cm.getOption(\"lineWrapping\");\n    var singleLineH = wrapping && cm.defaultTextHeight() * 1.5;\n    var curLine = null, curLineObj = null;\n\n    function getY(pos, top) {\n      if (curLine != pos.line) {\n        curLine = pos.line\n        curLineObj = cm.getLineHandle(pos.line)\n        var visual = cm.getLineHandleVisualStart(curLineObj)\n        if (visual != curLineObj) {\n          curLine = cm.getLineNumber(visual)\n          curLineObj = visual\n        }\n      }\n      if ((curLineObj.widgets && curLineObj.widgets.length) ||\n          (wrapping && curLineObj.height > singleLineH))\n        return cm.charCoords(pos, \"local\")[top ? \"top\" : \"bottom\"];\n      var topY = cm.heightAtLine(curLineObj, \"local\");\n      return topY + (top ? 0 : curLineObj.height);\n    }\n\n    var lastLine = cm.lastLine()\n    if (cm.display.barWidth) for (var i = 0, nextTop; i < anns.length; i++) {\n      var ann = anns[i];\n      if (ann.to.line > lastLine) continue;\n      var top = nextTop || getY(ann.from, true) * hScale;\n      var bottom = getY(ann.to, false) * hScale;\n      while (i < anns.length - 1) {\n        if (anns[i + 1].to.line > lastLine) break;\n        nextTop = getY(anns[i + 1].from, true) * hScale;\n        if (nextTop > bottom + .9) break;\n        ann = anns[++i];\n        bottom = getY(ann.to, false) * hScale;\n      }\n      if (bottom == top) continue;\n      var height = Math.max(bottom - top, 3);\n\n      var elt = frag.appendChild(document.createElement(\"div\"));\n      elt.style.cssText = \"position: absolute; right: 0px; width: \" + Math.max(cm.display.barWidth - 1, 2) + \"px; top: \"\n        + (top + this.buttonHeight) + \"px; height: \" + height + \"px\";\n      elt.className = this.options.className;\n      if (ann.id) {\n        elt.setAttribute(\"annotation-id\", ann.id);\n      }\n    }\n    this.div.textContent = \"\";\n    this.div.appendChild(frag);\n  };\n\n  Annotation.prototype.clear = function() {\n    this.cm.off(\"refresh\", this.resizeHandler);\n    this.cm.off(\"markerAdded\", this.resizeHandler);\n    this.cm.off(\"markerCleared\", this.resizeHandler);\n    if (this.changeHandler) this.cm.off(\"changes\", this.changeHandler);\n    this.div.parentNode.removeChild(this.div);\n  };\n}"],"names":[],"mappings":"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"}